# 変更履歴（Changelog）

## 2023-04-03

### 修正内容
- マニフェストファイルのエラーを修正
  - `content_scripts[0].matches[1]` の無効なスキーム (`chrome-extension://*/*.pdf`) を削除
  - `<all_urls>` のみを使用するように変更
  - `web_accessible_resources`の`matches`から`chrome-extension://*/*`を削除
  - `host_permissions`から`chrome-extension://*/*`を削除

- ポップアップUIの視認性と外観を改善
  - ポップアップの背景色を明るくして可視性を向上 (#474747, #555555 → グラデーション)
  - 四角の角が自然な丸みを持つように修正
  - HTMLインラインスタイルとCSSの両方で角の丸みを確保
  - グラスモーフィズム効果を追加（背景ぼかし、半透明効果）を削除し、シンプルな背景に変更
  - アニメーションを追加（フェードイン、パルス、グロー効果）
  - モダンなUIデザインへの刷新（Googleフォント、Font Awesomeアイコン）
  - 日本語表示への対応
  - テーマに合わせたアクセントカラーの変更機能
  - 上部タイトルとアイコンを削除し、よりシンプルな外観に変更
  - 画面端の白い部分を完全に排除し、透明処理を徹底 -> 失敗、濃色背景に変更
  - 白い外枠を目立たなくするためのデザイン調整（bodyパディング、内向きの影）を元に戻し、レイアウト崩れを修正
  - 白い外枠を目立たなくするためのデザイン調整（意図的に内側の細い境界線を追加）を削除
  - 白い外枠を目立たなくするためのデザイン調整（外側の影を調整して端をごまかす）を削除
  - 白い外枠を受け入れ、デザインとして意図的な枠線を追加 を削除
  - 白い外枠対策として、「入れ子」構造でスタイルを分離（.popup-containerと.containerの役割分担）-> 構造を簡略化
  - 縦長のレイアウトを修正し、元のコンパクトなサイズ感に戻す (.containerのheightを削除)
  - 白い外枠対策として、外側コンテナにソフトな影を追加し、内側コンテナの角丸をわずかに小さくする を削除
  - 根本対策として、提供された推奨セットアップ（固定サイズ、濃色背景、シンプルグラデ、内向き影）を適用
  - テーマ見本のはみ出しを修正（サイズとギャップ調整）

- **ちらつき・色変化（FOUC）対策**
  - `manifest.json`で`content.js`の`run_at`を`document_start`に変更
  - `content.js`でスクリプト開始直後に一時的なダークスタイルを適用するロジックを追加
  - `DOMContentLoaded`後に設定を読み込み、本スタイル適用 or 一時スタイル削除を行うように変更
  - PDF検出やObserver設定を`DOMContentLoaded`後に移動
  - `applyDarkMode`と`removeDarkMode`で一時スタイルも確実に削除するように修正
  - 一時スタイルの色をデフォルトテーマ(theme1)の色に合わせ、色変化を軽減
  - `applyDarkMode`内で既存スタイル削除後に`requestAnimationFrame`を挟み、描画更新を待ってから新スタイルを適用するように修正（テーマ変更直後の色戻り対策）

- **ちらつき・色変化（FOUC）対策（Dark Reader参考方式）**
  - `content.js` の `run_at` を `document_start` に設定。
  - スクリプト開始直後に、`<html>` 要素へ直接CSSフィルタ (`filter: invert(1) ...`) を適用する一時スタイル (`applyTemporaryFilter`) を実装し、即座にページを暗転させてちらつきを防止。
  - ダークモードの本スタイルは、ID (`the-dark-mode-style`) を持つ単一の `<style>` タグで管理。
  - テーマ適用/変更時 (`applyDarkMode`) は、一時フィルタを削除後、既存のスタイルタグの内容を新しいテーマCSSで**書き換える**方式に変更。タグが存在しない場合は新規作成。これによりDOM操作を最小限にし、タイミング問題を軽減。
  - ダークモード解除時 (`removeDarkModeStyleTag`) は、スタイルタグを削除し、一時フィルタも確実に解除する。
  - 色情報に依存しない一時フィルタにより、テーマ変更時に前テーマの色が一瞬表示される問題を解消。

- PDFビューワーサポートの改善
  - URLパターンではなくJavaScriptロジックでPDFを検出するように変更
  - `isPdfViewer()` 関数を追加してURL拡張子とDOM要素の両方でPDFを検出
  - PDFビューワー用のMutationObserverを改善して動的に生成される要素に対応

- 全体的なコード改善
  - イベントハンドラの構造を改善
  - エラー処理の強化
  - ログ出力の改善
  - CSSでの変数活用による一貫性のあるデザイン
  - MutationObserverによる動的スタイル監視の追加 -> 削除
  - JavaScriptでの不要なスタイル操作を削除

### 既知の問題
- （解消された可能性）ブラウザ仕様により、ポップアップ最外周の細い白い枠線を完全に削除できない可能性がある 